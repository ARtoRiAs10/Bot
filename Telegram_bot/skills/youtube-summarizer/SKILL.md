---
name: youtube-summarizer
description: >
  Summarize YouTube videos and answer questions about them using Gemini AI.
  Trigger when user sends a YouTube URL (youtube.com, youtu.be, shorts),
  asks to summarize/explain/break down a video, requests key points or timestamps,
  asks follow-up questions about video content, or requests responses in
  Hindi, Tamil, Telugu, Kannada, Marathi, or Bengali.
version: 2.0.0
metadata:
  openclaw:
    emoji: "üé¨"
    requires:
      env:
        - GEMINI_API_KEY
        - TELEGRAM_BOT_TOKEN
      bins:
        - python3
    install:
      - id: pip-deps
        kind: shell
        label: "Installing Python dependencies"
        command: >
          pip3 install google-generativeai python-telegram-bot
          sentence-transformers faiss-cpu torch numpy
          python-dotenv --quiet
---

# YouTube Summarizer & Q&A ‚Äî Gemini Native

This skill uses Gemini 2.0 Flash to directly watch YouTube videos,
extract full transcripts with timestamps, and generate structured summaries
and Q&A ‚Äî no external transcript APIs required.

---

## Architecture

```
YouTube URL
    ‚Üì
Gemini 2.0 Flash watches the video directly
    ‚Üì
Extracts full timestamped transcript as JSON
    ‚Üì
Stored in cache (memory or Redis)
    ‚Üì
Summary generated by Gemini ‚Üí sent to user
    ‚Üì
Transcript chunks embedded locally (sentence-transformers, free)
    ‚Üì
FAISS index built per-video, per-user
    ‚Üì
Q&A: question ‚Üí FAISS search ‚Üí top-4 chunks ‚Üí Gemini answers
    ‚Üì
"NOT_COVERED" returned if topic absent from transcript
```

---

## Trigger Conditions

Activate this skill when the user:
- Sends any URL containing `youtube.com`, `youtu.be`, or `youtube.com/shorts`
- Says "summarize this video", "what does this video say about X"
- Says "explain this video", "break this down", "give me key points"
- Uses commands: `/summary`, `/deepdive`, `/actionpoints`
- Says "summarize in Hindi / Tamil / Telugu / Kannada / Marathi / Bengali"
- Asks any follow-up question after a video has been loaded this session

Do NOT activate for non-YouTube URLs or generic questions unrelated to video content.

---

## Session State Per User

```
session[chat_id] = {
  "video_id":   str | None,
  "title":      str | None,
  "language":   str,             # default "English"
  "history":    list[dict],      # last 10 Q&A turns
  "qa_index":   QAIndex | None,  # FAISS index for this video
}
```

---

## STEP 1 ‚Äî Validate YouTube URL

Extract the 11-character video ID:
```
pattern: (?:youtube\.com/(?:watch\?v=|shorts/|embed/)|youtu\.be/)([a-zA-Z0-9_-]{11})
```

If no valid ID found:
```
‚ùå That doesn't look like a valid YouTube URL.
Please send a link like: https://youtube.com/watch?v=VIDEO_ID
```
Stop.

---

## STEP 2 ‚Äî Fetch Transcript via Gemini

Send the YouTube URL to Gemini 1.5 Flash as video content.
Ask Gemini to return a JSON transcript with this exact structure:

```json
{
  "title": "Video Title",
  "duration": "12:34",
  "description": "One sentence topic description",
  "language_original": "English",
  "transcript": [
    { "timestamp": "0:00", "start_seconds": 0, "text": "spoken words here" },
    { "timestamp": "0:30", "start_seconds": 30, "text": "more spoken words" }
  ]
}
```

**Error handling:**

| Gemini response | User message |
|----------------|-------------|
| Rate limit / 429 | ‚ö†Ô∏è Rate limited. Wait 1 minute and retry. |
| Video unavailable / blocked | ‚ùå Video is private, age-restricted, or unavailable. |
| No speech content | ‚ö†Ô∏è This video has no spoken content. |
| JSON parse failure | ‚ùå Could not process video. Try a different one. |

Show user: `‚è≥ Gemini is watching the video‚Ä¶ (20‚Äì60 seconds)`

---

## STEP 3 ‚Äî Generate Structured Summary

Use Gemini to generate the summary in this **exact format** (PDF requirement):

```
üé• *{Video Title}*
‚è± Duration: {duration}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìå *5 Key Points*

1. [Key point ‚Äî one clear sentence]
2. [Key point ‚Äî one clear sentence]
3. [Key point ‚Äî one clear sentence]
4. [Key point ‚Äî one clear sentence]
5. [Key point ‚Äî one clear sentence]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚è± *Important Timestamps*

‚Ä¢ [MM:SS] ‚Äî [What is discussed at this moment]
‚Ä¢ [MM:SS] ‚Äî [What is discussed at this moment]
‚Ä¢ [MM:SS] ‚Äî [What is discussed at this moment]
‚Ä¢ [MM:SS] ‚Äî [What is discussed at this moment]
‚Ä¢ [MM:SS] ‚Äî [What is discussed at this moment]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üß† *Core Takeaway*

[One powerful sentence capturing the video's main value]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí¨ *Who Should Watch This*

[1‚Äì2 sentences about target audience]
```

Timestamps in the ‚è± section MUST come from actual transcript entries.
All 5 key points MUST come from actual video content.

After summary, send a follow-up:
```
üí¨ *Ask me anything about this video!*
Commands: /deepdive ‚Ä¢ /actionpoints ‚Ä¢ /summary ‚Ä¢ /reset
```

---

## STEP 4 ‚Äî Q&A (Follow-up Questions)

When a video is loaded and user asks a question:

1. Embed question with local sentence-transformers (free, no API)
2. Search FAISS for top-4 most relevant transcript chunks
3. Send chunks + question to Gemini with strict grounding instruction
4. If Gemini cannot find the answer in the chunks ‚Üí return `NOT_COVERED`

**If `NOT_COVERED`:**
```
‚ÑπÔ∏è *This topic is not covered in the video.*

The video focuses on: {video description}

Would you like to ask something else?
```

**If answered:** send response directly. Cite timestamp if relevant.

Keep last 10 Q&A turns in history for multi-turn context.

---

## STEP 5 ‚Äî /deepdive Command

Generate in-depth analysis using this format:

```
üîç *Deep Dive: {Video Title}*

üéØ *Main Thesis*
[Central argument ‚Äî 2-3 sentences]

üìö *Key Concepts Explained*
1. *{Concept}* ‚Äî [Explanation]
2. *{Concept}* ‚Äî [Explanation]
3. *{Concept}* ‚Äî [Explanation]

üí° *Evidence & Examples Used*
‚Ä¢ [MM:SS] ‚Äî [Example from video]
‚Ä¢ [MM:SS] ‚Äî [Example from video]

‚öñÔ∏è *Critical Evaluation*
‚úÖ Strengths: [list]
‚ö†Ô∏è Limitations: [list]

üîó *Broader Context*
[How this connects to wider topics]

üìñ *Suggested Next Steps*
‚Ä¢ [Topic to explore]
‚Ä¢ [Topic to explore]
```

---

## STEP 6 ‚Äî /actionpoints Command

Generate action items using this format:

```
‚úÖ *Action Points ‚Äî {Video Title}*

‚ö° *Quick Wins (under 1 hour)*
1. [Specific action]
2. [Specific action]

üìÖ *Short-term Actions (this week)*
1. [Specific action]
2. [Specific action]

üèÜ *Long-term Goals*
1. [Specific goal]

üõ†Ô∏è *Tools & Resources Mentioned*
‚Ä¢ [Tool] ‚Äî [Purpose]

üéØ *#1 Priority Action*
[Single most impactful thing to do first]
```

---

## Language Handling

Detect language switch when user says:

| Trigger | Language |
|---------|---------|
| "in Hindi" / "‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç" | Hindi |
| "in Tamil" / "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Æø‡Æ≤‡Øç" | Tamil |
| "in Telugu" / "‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã" | Telugu |
| "in Kannada" / "‡≤ï‡≤®‡≥ç‡≤®‡≤°‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø" | Kannada |
| "in Marathi" / "‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§" | Marathi |
| "in Bengali" / "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º" | Bengali |
| "in English" | English |

On language switch:
1. Update `session.language`
2. Confirm: `üåê Switched to {Language}!`
3. If video loaded ‚Üí regenerate summary in new language (check cache first)

Pass language to ALL Gemini prompts. Gemini generates natively ‚Äî no translation layer.

---

## Caching Rules

| Data | Cache key | When to use cache |
|------|----------|------------------|
| Transcript JSON | `v:{video_id}` | Always check before calling Gemini |
| Summary text | `s:{video_id}:{language}` | Always check before calling Gemini |

Show `‚ö° Cache hit ‚Äî loaded instantly!` when transcript is cached.

---

## Edge Cases

| Situation | Handling |
|-----------|---------|
| Video > 1 hour | Warn user: processing may be slower. Gemini 1.5 Flash supports ~1hr. |
| Non-English video | Gemini transcribes and notes original language. Proceed normally. |
| No speech (music video) | Raise error with clear message. |
| Rate limit (15 RPM free) | Auto-retry after 60s. Inform user if second attempt fails. |
| Question before video | Ask user to send a link first. |
| Same video, second user | Cache hit ‚Äî instant load, no Gemini call. |

---

## Rules

- NEVER hallucinate. Q&A answers must come from transcript chunks only.
- NEVER skip the structured summary format. All sections are required.
- NEVER use a translation library ‚Äî Gemini generates in the target language natively.
- ALWAYS show loading message before any Gemini call (they take 20-60s).
- ALWAYS use real timestamps from the transcript in the ‚è± section.
- ALWAYS check cache before calling Gemini.
